<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="QuickPro - Classroom Engagement Platform">
  
  <!-- Prevent caching for immediate updates -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="QuickPro">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>QuickPro</title>
  <link rel="manifest" href="manifest.json">
  
  <style>
    /* Loading screen styles */
    .loading-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #2563eb;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease-out;
    }
    .loading-container.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      margin-top: 20px;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 16px;
      font-weight: 500;
    }
    .loading-version {
      margin-top: 10px;
      color: rgba(255, 255, 255, 0.7);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div id="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading QuickPro...</div>
    <div class="loading-version">Checking for updates</div>
  </div>

  <!-- Service Worker Registration & Version Check -->
  <script>
    (function() {
      'use strict';
      
      const APP_VERSION = '1.0.0'; // Update this when you deploy new version
      const AUTO_UPDATE_ENABLED = false; // Set to true only when deploying updates
      const loadingEl = document.getElementById('loading');
      const versionEl = loadingEl.querySelector('.loading-version');
      
      console.log('üöÄ QuickPro v' + APP_VERSION + ' - Initializing...');
      
      // Function to hide loading screen
      function hideLoading() {
        if (loadingEl && !loadingEl.classList.contains('fade-out')) {
          loadingEl.classList.add('fade-out');
          setTimeout(() => {
            loadingEl.style.display = 'none';
          }, 300);
        }
      }
      
      // Function to check for updates and force refresh if needed
      function checkForUpdates() {
        const lastVersion = localStorage.getItem('app_version');
        const currentVersion = APP_VERSION;
        const lastCheck = localStorage.getItem('last_version_check');
        const now = Date.now();
        
        console.log('üì¶ Version check:', { lastVersion, currentVersion, autoUpdateEnabled: AUTO_UPDATE_ENABLED });
        
        // If auto-update is disabled, just store version and return
        if (!AUTO_UPDATE_ENABLED) {
          localStorage.setItem('app_version', currentVersion);
          console.log('üõ†Ô∏è Auto-update disabled (development mode)');
          return false;
        }
        
        // Prevent reload loop - only check once per 10 seconds
        if (lastCheck && (now - parseInt(lastCheck)) < 10000) {
          console.log('‚è≠Ô∏è Skipping version check (checked recently)');
          return false;
        }
        
        localStorage.setItem('last_version_check', now.toString());
        
        if (lastVersion && lastVersion !== currentVersion) {
          console.log('üîÑ New version detected! Clearing caches...');
          versionEl.textContent = 'New version found! Updating...';
          
          // Mark that we're updating to prevent loop
          localStorage.setItem('updating_to_version', currentVersion);
          
          // Clear all caches
          if ('caches' in window) {
            caches.keys().then(keys => {
              keys.forEach(key => caches.delete(key));
              console.log('‚úÖ Caches cleared');
            });
          }
          
          // Clear service worker
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
              registrations.forEach(registration => registration.unregister());
              console.log('‚úÖ Service workers unregistered');
            });
          }
          
          // Update version and reload
          localStorage.setItem('app_version', currentVersion);
          localStorage.setItem('last_updated', new Date().toISOString());
          
          setTimeout(() => {
            console.log('‚ôªÔ∏è Reloading with new version...');
            window.location.reload(true);
          }, 500);
          
          return true;
        }
        
        // Store current version
        localStorage.setItem('app_version', currentVersion);
        localStorage.setItem('last_updated', new Date().toISOString());
        
        return false;
      }
      
      // Register service worker (simplified)
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('service-worker.js', {
            scope: '/',
            updateViaCache: 'none'
          })
          .then(registration => {
            console.log('‚úÖ Service Worker registered');
          })
          .catch(err => {
            console.warn('‚ö†Ô∏è Service Worker registration failed:', err);
          });
        });
      }
      
      // Check for version updates
      const updatingTo = localStorage.getItem('updating_to_version');
      if (updatingTo === APP_VERSION) {
        localStorage.removeItem('updating_to_version');
        console.log('‚úÖ Update completed successfully');
      }
      
      const needsUpdate = checkForUpdates();
      if (!needsUpdate) {
        versionEl.textContent = 'v' + APP_VERSION;
      }
      
      // Hide loading screen when Flutter is ready
      window.addEventListener('flutter-first-frame', hideLoading);
      
      // Critical: Always hide after 3 seconds as fallback
      setTimeout(() => {
        console.log('‚è∞ Timeout: Force hiding loading screen');
        hideLoading();
      }, 3000);
      
    })();
  </script>
  
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
